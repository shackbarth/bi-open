language: c

script:
  # Basic setup of the xtuple-server, from the xtuple-server wiki
  - wget git.io/hikK5g -qO- | sudo bash
  - npm install -g xtuple-server
  - cd ..

  # The FOSS xtuple-server requires an existing xtuple directory to start working off of
  - git clone https://github.com/xtuple/xtuple.git
  - git clone https://github.com/xtuple/xtuple-extensions.git

  # Temporary hack: we need the bleeding-edge code to access the BI reshuffle. XXX remove after 4.6 beta
  - cd xtuple-extensions
  - git checkout 4_6_x
  - cd ../xtuple
  - git checkout 4_6_x
  - cd ..

  # Use the server to do an install
  - sudo xtuple-server install-dev --xt-name bitest --xt-quickstart --local-workspace ./xtuple --xt-adminpw qwerty --verbose

  # Install BI and perform ETL
  - cd bi-open/scripts
  - ls -l ../../xtuple/node-datasource
  - sudo bash build_bi.sh -eblm -c ../../xtuple/node-datasource/config.js -d quickstart_dev -P qwerty
  - sudo bash start_bi.sh

  # Install the bi-open extension. TODO: build this into the xtuple-server install as a flag
  - cd ../../xtuple
  - ./scripts/build_app.js -d quickstart_dev -e ../xtuple-extensions/bi-open

  # Start the app.
  - npm start &
  - sleep 10

  # TODO: run a test to make sure that BI is accessible and the ETL worked

after_failure:
  - sudo cat /var/spool/cron/crontabs/travis
  - sudo cat /var/spool/cron/crontabs/root
  - sudo find / -name xtuple-server.log
  - sudo cat xtuple-server.log
  - env
